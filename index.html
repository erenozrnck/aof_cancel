<!doctype html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDF Soru İptal Aracı</title>
    <style>
        body {
            font-family: system-ui, Arial;
            margin: 24px;
        }

        .box {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            max-width: 760px;
        }

        input {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 100%;
        }

        button {
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        .row {
            display: grid;
            gap: 10px;
        }

        .hint {
            font-size: 13px;
            opacity: .75;
        }
    </style>
</head>

<body>
    <h2>PDF’de İptal Soruları Uygula</h2>

    <div class="box row">
        <label>PDF Seç:
            <input type="file" id="pdfFile" accept="application/pdf" />
        </label>

        <label>İptal edilen sorular (örn: 3, 8, 12):
            <input id="iptalInput" placeholder="3, 8, 12" />
        </label>

        <label>Cevabı Değişen Sorular (örn: 60:A, 12:C):
            <input id="degisiklikInput" placeholder="60:A, 12:C" />
        </label>

        <label>Tarih:
            <input type="date" id="tarihInput" />
        </label>

        <button id="runBtn">Uygula ve PDF Oluştur</button>
        <div class="hint">Not: Sunucu endpoint’i <code>/cancel</code> olmalı.</div>

        <a id="downloadLink" style="display:none; margin-top:10px;">İndir</a>
    </div>

    <script>
        // Sayfa yüklendiğinde bugünün tarihini input'a ata
        document.getElementById("tarihInput").valueAsDate = new Date();

        function parseIptal(text) {
            return [...new Set(
                (text || "")
                    .split(/[\s,;]+/)
                    .map(s => s.trim())
                    .filter(Boolean)
                    .map(Number)
                    .filter(n => Number.isInteger(n) && n > 0)
            )];
        }

        document.getElementById("runBtn").addEventListener("click", async () => {
            const f = document.getElementById("pdfFile").files[0];
            if (!f) return alert("PDF seçmelisin.");

            const iptal = parseIptal(document.getElementById("iptalInput").value);
            const degisiklik = document.getElementById("degisiklikInput").value;
            const tarih_val = document.getElementById("tarihInput").value;

            // Tarih formatını DD.MM.YYYY çevirelim (input type=date YYYY-MM-DD verir)
            let formattedDate = "";
            if (tarih_val) {
                const parts = tarih_val.split("-"); // [YYYY, MM, DD]
                if (parts.length === 3) {
                    formattedDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                }
            }

            const fd = new FormData();
            fd.append("pdf", f);
            fd.append("iptal", iptal.join(","));
            fd.append("degisiklik", degisiklik);
            fd.append("tarih", formattedDate);

            const res = await fetch("/cancel", { method: "POST", body: fd });
            if (!res.ok) {
                const t = await res.text().catch(() => "");
                return alert("Hata: " + (t || res.status));
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);

            const a = document.getElementById("downloadLink");
            a.href = url;
            a.download = "sinav_iptalli.pdf";
            a.textContent = "İptalli PDF’i indir";
            a.style.display = "inline-block";
        });
    </script>
</body>

</html>